<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>S.A.R. UNITÃ€ MERLINI - V28.0 TOTAL CONTROL</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>

    <style>
        :root {
            --bg-dark: #0a0b0d;
            --panel-bg: #161b22;
            --pc-yellow: #ffcc00;
            --pc-blue: #218bff;
            --danger: #fa4549;
            --success: #238636;
            --border: #30363d;
            --text-main: #e6edf3;
            --ai-purple: #8957e5;
            --tg-color: #0088cc;
        }

        /* --- STILE BASE --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            background: var(--bg-dark); 
            color: var(--text-main); 
            font-family: -apple-system, "Segoe UI", sans-serif;
            margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }

        /* --- LOGIN --- */
        #loginScreen {
            position: fixed; inset: 0; background: #0d1117; z-index: 10000;
            display: flex; align-items: center; justify-content: center;
        }
        .login-card {
            background: var(--panel-bg); padding: 40px; border-radius: 20px; border: 1px solid var(--border);
            text-align: center; width: 90%; max-width: 400px; box-shadow: 0 10px 50px rgba(0,0,0,0.8);
        }

        /* --- HEADER --- */
        .top-bar {
            background: #000; padding: 15px 20px; border-bottom: 2px solid var(--pc-yellow);
            display: flex; justify-content: space-between; align-items: center;
        }
        .logo { font-weight: 900; letter-spacing: 1px; font-size: 14px; }
        .logo span { color: var(--pc-yellow); }

        /* --- NAVIGATION --- */
        .main-nav {
            display: flex; background: #0d1117; padding: 10px; gap: 10px; 
            overflow-x: auto; border-bottom: 1px solid var(--border);
        }
        .nav-btn {
            padding: 12px 18px; background: var(--panel-bg); color: #8b949e;
            border: 1px solid var(--border); border-radius: 8px; font-size: 10px;
            font-weight: 800; text-transform: uppercase; cursor: pointer; white-space: nowrap; transition: 0.3s;
        }
        .nav-btn.active { background: var(--pc-yellow); color: #000; border-color: var(--pc-yellow); }

        /* --- CONTENT --- */
        .content { flex: 1; overflow-y: auto; padding: 20px; }
        .section { display: none; max-width: 800px; margin: 0 auto; }
        .section.active { display: block; animation: fadeIn 0.4s ease; }

        .card { background: var(--panel-bg); border: 1px solid var(--border); border-radius: 12px; padding: 25px; margin-bottom: 20px; }
        h2 { font-size: 13px; text-transform: uppercase; color: var(--pc-yellow); margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }

        /* --- FORMS & INPUTS --- */
        .form-group { margin-bottom: 15px; }
        label { display: block; font-size: 9px; font-weight: 800; color: #8b949e; text-transform: uppercase; margin-bottom: 5px; }
        input, select, textarea {
            width: 100%; background: #0d1117; border: 1px solid var(--border);
            border-radius: 8px; padding: 12px; color: #fff; font-size: 14px;
        }

        /* --- BUTTONS --- */
        .btn {
            width: 100%; padding: 15px; border-radius: 10px; border: none; font-weight: 800;
            font-size: 11px; text-transform: uppercase; cursor: pointer; display: flex;
            align-items: center; justify-content: center; gap: 10px; margin-bottom: 10px;
        }
        .btn-green { background: var(--success); color: #fff; }
        .btn-ai { background: var(--ai-purple); color: #fff; border-bottom: 4px solid #5d3bb1; }
        .btn-blue { background: var(--pc-blue); color: #fff; }
        .btn-tg { background: var(--tg-color); color: #fff; }
        .btn-danger { background: var(--danger); color: #fff; padding: 8px; font-size: 9px; width: auto; }

        /* --- LISTS & CARDS --- */
        .item-row {
            background: #0d1117; padding: 15px; border-radius: 10px; margin-bottom: 10px;
            display: flex; align-items: center; justify-content: space-between; border-left: 4px solid var(--pc-blue);
        }
        .qr-box { background: white; padding: 5px; border-radius: 8px; display: flex; align-items: center; justify-content: center; }
        
        #map { height: 350px; border-radius: 12px; border: 1px solid var(--border); }
        #reader { width: 100%; border-radius: 12px; overflow: hidden; background: #000; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div id="loginScreen">
    <div class="login-card">
        <h1 style="color:var(--pc-yellow);">S.A.R. MERLINI</h1>
        <input type="password" id="pinInput" inputmode="numeric" placeholder="INSERIRE PIN" style="text-align:center; font-size:30px; letter-spacing:10px;">
        <button class="btn btn-blue" style="margin-top:20px;" onclick="checkPin()">AUTENTICAZIONE</button>
    </div>
</div>

<header class="top-bar">
    <div class="logo">SAR <span>COMMAND</span></div>
    <div id="liveClock" style="font-weight:bold; font-size:12px;">00:00:00</div>
</header>

<nav class="main-nav">
    <button class="nav-btn active" onclick="openTab('missione', this)">Missions</button>
    <button class="nav-btn" onclick="openTab('scanner', this)">Scanner</button>
    <button class="nav-btn" onclick="openTab('anagrafica', this)">Anagrafica</button>
    <button class="nav-btn" onclick="openTab('appello', this)">Appello</button>
</nav>

<div class="content">
    
    <div id="tab-missione" class="section active">
        <div class="card">
            <h2>LOGISTICA ATTIVAZIONE</h2>
            <div class="form-group">
                <label>Natura Evento</label>
                <input type="text" id="ev_tipo" placeholder="Es: persona dispersa bosco">
            </div>
            <div class="form-group">
                <label>AutoritÃ  Richiedente</label>
                <input type="text" id="ev_autorita" placeholder="Es: carabinieri">
            </div>
            <div class="form-group">
                <label>Responsabile UnitÃ  (R.O.)</label>
                <input type="text" id="ev_resp" placeholder="Nome Coordinatore">
            </div>
            <div style="display:flex; gap:10px;">
                <div class="form-group" style="flex:1">
                    <label>Attivazione</label>
                    <select id="ev_urg"><option>IMMEDIATA</option><option>PROGRAMMATA</option></select>
                </div>
                <div class="form-group" style="flex:1">
                    <label>Orario</label>
                    <input type="time" id="ev_time">
                </div>
            </div>

            <button class="btn btn-green" onclick="salvaInScaletta()">âœš AGGIUNGI IN SCALETTA</button>
            <button class="btn btn-ai" onclick="elaboraAI()">ðŸ§  ANALISI AI: FORMALIZZA TESTI</button>
        </div>

        <div class="card">
            <h2>MAPPA E TELEGRAM</h2>
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <input type="text" id="mapSearch" placeholder="Cerca localitÃ ...">
                <button onclick="cercaMappa()" class="btn btn-blue" style="width:80px; margin:0;">GO</button>
            </div>
            <div id="map"></div>
            <button class="btn btn-tg" style="margin-top:15px;" onclick="mandaTelegram()">âœˆ TRASMETTI ORDINE DI MISSIONE</button>
        </div>

        <div class="card">
            <h2>STORICO SCALETTA</h2>
            <div id="lista-eventi"></div>
        </div>
    </div>

    <div id="tab-scanner" class="section">
        <div class="card">
            <h2>SCANNER QR APPELLO</h2>
            <div id="reader"></div>
            <button class="btn btn-blue" style="margin-top:15px;" onclick="startScanner()">AVVIA TELECAMERA</button>
        </div>
    </div>

    <div id="tab-anagrafica" class="section">
        <div class="card">
            <h2>REGISTRA VOLONTARIO</h2>
            <input type="text" id="vol_nome" placeholder="NOME E COGNOME">
            <button class="btn btn-green" style="margin-top:10px;" onclick="addVolontario()">SALVA NEL CLOUD</button>
        </div>
        <div id="lista-anagrafica"></div>
    </div>

    <div id="tab-appello" class="section">
        <div class="card">
            <h2>UNITÃ€ OPERATIVE SUL POSTO</h2>
            <div id="lista-appello"></div>
        </div>
    </div>

</div>

<script>
    // --- DATI GIOVANNI ---
    const PIN_SAVE = "123456789";
    const TG_TOKEN = "8237203800:AAGzZi2zgPyAa6bCunZkNCzH7hlz5rNykVA";
    const TG_CHAT_ID = "-1003709844017";

    const firebaseConfig = {
        apiKey: "AIzaSyB5AhJZSLu3om-VUsoQBX9KazvtzAkAoa0",
        authDomain: "merlini-sar.firebaseapp.com",
        databaseURL: "https://merlini-sar-default-rtdb.firebaseio.com", 
        projectId: "merlini-sar",
        storageBucket: "merlini-sar.firebasestorage.app",
        messagingSenderId: "654419107383",
        appId: "1:654419107383:web:d84686c7c305e87d6969b2"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let map, marker, html5QrCode;

    function checkPin() {
        if(document.getElementById('pinInput').value === PIN_SAVE) {
            document.getElementById('loginScreen').style.display = 'none';
            initApp();
        } else { alert("ACCESSO NEGATO"); }
    }

    function initApp() {
        map = L.map('map').setView([45.856, 9.397], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        map.on('click', e => { 
            if(marker) map.removeLayer(marker); 
            marker = L.marker(e.latlng).addTo(map); 
        });
        syncCloud();
    }

    // --- LOGICA IA RISCRITTURA ---
    function elaboraAI() {
        const tInput = document.getElementById('ev_tipo');
        const aInput = document.getElementById('ev_autorita');
        const rInput = document.getElementById('ev_resp');

        let t = tInput.value.toLowerCase();
        let a = aInput.value.toLowerCase();

        // Trasformazione parole chiave
        if(t.includes("ricerca") || t.includes("disperso")) tInput.value = "RICERCA PERSONA SCOMPARSA (SAR)";
        else if(t.includes("incendio") || t.includes("fuoco")) tInput.value = "INTERVENTO AIB - EMERGENZA INCENDIO";
        else tInput.value = "ATTIVAZIONE OPERATIVA: " + t.toUpperCase();

        if(a.includes("carabinieri") || a.includes("cc")) aInput.value = "ARMA DEI CARABINIERI - COMANDO LOCALE";
        else if(a.includes("vigili") || a.includes("vvf")) aInput.value = "VIGILI DEL FUOCO (VVF)";
        else aInput.value = a.toUpperCase();

        rInput.value = "R.O. " + rInput.value.toUpperCase();
        alert("âœ¨ IA: Campi formalizzati correttamente!");
    }

    // --- FUNZIONALITÃ€ MISSIONI ---
    function salvaInScaletta() {
        const val = {
            tipo: document.getElementById('ev_tipo').value,
            aut: document.getElementById('ev_autorita').value,
            resp: document.getElementById('ev_resp').value,
            urg: document.getElementById('ev_urg').value,
            ora: document.getElementById('ev_time').value,
            ts: Date.now()
        };
        if(!val.tipo) return alert("Inserire natura evento");
        db.ref('merlini/scaletta').push(val);
        alert("Missione Archiviata!");
    }

    async function mandaTelegram() {
        const t = document.getElementById('ev_tipo').value;
        const r = document.getElementById('ev_resp').value;
        const o = document.getElementById('ev_time').value || "ASAP";
        let gps = "";
        if(marker) {
            const l = marker.getLatLng();
            gps = `\nðŸ“ POSIZIONE: [Mappa Live](https://www.google.com/maps?q=${l.lat},${l.lng})`;
        }
        const msg = `ðŸš¨ ALLERTA SAR MERLINI\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\nðŸ“Œ EVENTO: ${t}\nðŸ•’ RITROVO: ${o}\nðŸ‘¤ RESP: ${r}${gps}\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”`;
        
        await fetch(`https://api.telegram.org/bot${TG_TOKEN}/sendMessage`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ chat_id: TG_CHAT_ID, text: msg, parse_mode: 'Markdown' })
        });
        alert("Inviato a Gruppo Telegram!");
    }

    async function cercaMappa() {
        const q = document.getElementById('mapSearch').value;
        const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}`);
        const d = await r.json();
        if(d.length > 0) {
            const p = [d[0].lat, d[0].lon];
            map.setView(p, 16);
            if(marker) map.removeLayer(marker);
            marker = L.marker(p).addTo(map);
        }
    }

    // --- FUNZIONALITÃ€ ANAGRAFICA & SCANNER ---
    function addVolontario() {
        const n = document.getElementById('vol_nome').value.toUpperCase().trim();
        if(!n) return;
        const id = "M-" + btoa(n).substr(0,6).toUpperCase();
        db.ref('merlini/anagrafica/'+id).set({ id, nome: n, stato: "ASSENTE", ora: "--:--" });
        document.getElementById('vol_nome').value = "";
    }

    function startScanner() {
        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, id => {
            const h = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            db.ref('merlini/anagrafica/'+id).update({ stato: "PRESENTE", ora: h });
            alert("REGISTRATO!");
            html5QrCode.stop();
        }).catch(err => alert("Errore camera"));
    }

    // --- SINCRONIZZAZIONE DATI ---
    function syncCloud() {
        // Scaletta Live
        db.ref('merlini/scaletta').on('value', s => {
            const data = s.val() || {};
            document.getElementById('lista-eventi').innerHTML = Object.values(data).reverse().map(e => `
                <div class="item-row"><div><b>${e.tipo}</b><br><small>${e.aut} | ${e.ora}</small></div></div>
            `).join('');
        });

        // Anagrafica e Appello Live
        db.ref('merlini/anagrafica').on('value', s => {
            const list = Object.values(s.val() || {}).sort((a,b) => a.nome.localeCompare(b.nome));
            
            // Render Anagrafica (con QR)
            document.getElementById('lista-anagrafica').innerHTML = list.map((v, i) => `
                <div class="item-row">
                    <div id="qrv-${i}" class="qr-box"></div>
                    <div style="flex:1; margin-left:15px"><b>${v.nome}</b><br><small>${v.id}</small></div>
                    <button class="btn-danger" onclick="delVol('${v.id}')">ELIMINA</button>
                </div>
            `).join('');
            list.forEach((v, i) => new QRCode(document.getElementById(`qrv-${i}`), { text: v.id, width: 60, height: 60 }));

            // Render Appello
            document.getElementById('lista-appello').innerHTML = list.map(v => `
                <div class="item-row" style="border-left-color: ${v.stato==='PRESENTE'?'var(--success)':'var(--danger)'}">
                    <b>${v.nome}</b> <span>${v.stato} (${v.ora})</span>
                </div>
            `).join('');
        });
    }

    // --- UTILS ---
    function delVol(id) { if(confirm("Eliminare operatore?")) db.ref('merlini/anagrafica/'+id).remove(); }

    function openTab(id, btn) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('tab-'+id).classList.add('active');
        btn.classList.add('active');
        if(id === 'missione') setTimeout(() => map.invalidateSize(), 200);
    }

    setInterval(() => { document.getElementById('liveClock').innerText = new Date().toLocaleTimeString(); }, 1000);
</script>
</body>
</html>
