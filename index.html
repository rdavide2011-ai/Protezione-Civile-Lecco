<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>S.A.R. UNIT√Ä MERLINI - CONSOLE OPERATIVA</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --bg-dark: #0a0e14;
            --panel-bg: #161b22;
            --pc-yellow: #ffcc00;
            --pc-blue: #0056b3;
            --danger: #eb3b5a;
            --text-main: #e6edf3;
            --success: #2ea043;
            --border: #30363d;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background-color: var(--bg-dark); 
            color: var(--text-main); 
            margin: 0; 
            padding: 0; 
            min-height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow-x: hidden; 
        }

        /* SCHERMATA LOGIN */
        #loginOverlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: var(--bg-dark); z-index: 9999; 
            display: flex; align-items: center; justify-content: center; 
        }
        .login-box { 
            max-width: 350px; width: 90%; text-align: center; 
            background: var(--panel-bg); padding: 30px; 
            border-radius: 15px; border: 2px solid var(--pc-yellow); 
            box-shadow: 0 0 20px rgba(255, 204, 0, 0.2);
        }

        /* HEADER */
        .top-bar { 
            background: var(--panel-bg); padding: 10px 15px; 
            display: flex; align-items: center; justify-content: space-between; 
            border-bottom: 3px solid var(--pc-yellow); 
        }
        .logo-badge { 
            background: var(--pc-yellow); color: black; 
            width: 35px; height: 35px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            font-weight: bold; margin-right: 10px;
        }

        /* NAVIGAZIONE */
        .module-nav { 
            display: flex; background: #000; padding: 10px; 
            gap: 8px; overflow-x: auto; border-bottom: 1px solid var(--border); 
        }
        .nav-btn { 
            padding: 10px 18px; background: var(--panel-bg); 
            color: #8b949e; border: 1px solid var(--border); 
            border-radius: 8px; font-size: 11px; font-weight: bold;
            cursor: pointer; text-transform: uppercase; white-space: nowrap; 
        }
        .nav-btn.active { background: var(--pc-yellow); color: black; border-color: var(--pc-yellow); }

        /* CONTENITORE PRINCIPALE */
        .main-content { flex: 1; padding: 15px; max-width: 600px; margin: 0 auto; width: 100%; }
        .hidden { display: none !important; }

        /* FORM ELEMENTS */
        .card { background: var(--panel-bg); border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid var(--border); }
        .input-group { margin-bottom: 15px; display: flex; flex-direction: column; gap: 6px; }
        .input-group label { font-size: 11px; text-transform: uppercase; color: var(--pc-yellow); font-weight: bold; letter-spacing: 0.5px; }
        
        input, textarea, select { 
            width: 100%; background: #0d1117; border: 1px solid var(--border); 
            border-radius: 8px; color: white; padding: 12px; font-size: 15px; outline: none; 
        }
        input:focus { border-color: var(--pc-yellow); }

        .btn { 
            padding: 15px; border: none; border-radius: 10px; 
            font-weight: bold; font-size: 13px; text-transform: uppercase; 
            cursor: pointer; width: 100%; transition: 0.2s;
        }
        .btn-danger { background: var(--danger); color: white; }
        .btn-action { background: var(--pc-blue); color: white; }

        /* FOTO PREVIEW */
        #photoPreview { 
            width: 100%; border-radius: 8px; margin-top: 10px; 
            display: none; border: 2px solid var(--pc-blue); 
        }

        /* MODALE MAPPA */
        .modal-full { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: var(--bg-dark); z-index: 10000; flex-direction: column; 
        }
        #map { width: 100%; flex: 1; }
        .modal-footer { padding: 15px; background: var(--panel-bg); display: flex; gap: 10px; border-top: 1px solid var(--border); }
    </style>
</head>
<body onpointermove="resetTimer()" onclick="resetTimer()">

<div id="loginOverlay">
    <div class="login-box">
        <div style="font-size: 40px; margin-bottom: 10px;">üêï</div>
        <h2 style="color:var(--pc-yellow); margin: 0 0 20px 0; font-size: 18px;">UNIT√Ä MERLINI S.A.R.</h2>
        <input type="password" id="loginInput" inputmode="numeric" style="font-size: 24px; text-align: center; letter-spacing: 5px;" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        <button onclick="checkLogin()" class="btn" style="background: var(--pc-yellow); color: black; margin-top: 20px;">ACCEDI ALLA CONSOLE</button>
    </div>
</div>

<div class="top-bar">
    <div style="display:flex; align-items:center;">
        <div class="logo-badge">PC</div>
        <div>
            <div style="font-size:12px; font-weight:bold; color:var(--pc-yellow);">CONSOLE S.A.R.</div>
            <div style="font-size:9px; color:#8b949e;">PROTEZIONE CIVILE</div>
        </div>
    </div>
    <button onclick="location.reload()" style="background:#30363d; color:var(--danger); border:none; padding:6px 12px; border-radius:5px; font-size:10px; font-weight:bold;">LOGOUT</button>
</div>

<div class="module-nav">
    <button class="nav-btn active" id="btn-allerta" onclick="showMod('allerta')">üö® Allerta</button>
    <button class="nav-btn" id="btn-presenze" onclick="showMod('presenze')">üìù Presenze</button>
    <button class="nav-btn" id="btn-squadre" onclick="showMod('squadre')">üë• Squadre</button>
    <button class="nav-btn" id="btn-volontari" onclick="showMod('volontari')">üóÇÔ∏è Volontari</button>
</div>

<div class="main-content">
    
    <div id="mod-allerta">
        <div class="card">
            <div class="input-group">
                <label>Tipo di Evento</label>
                <input type="text" id="f_evento" placeholder="es: RICERCA PERSONA SCOMPARSA">
            </div>
            
            <div class="input-group">
                <label>Luogo / Coordinate</label>
                <div style="display:flex; gap:8px;">
                    <input type="text" id="f_luogo" placeholder="Inserisci o usa GPS">
                    <button onclick="getAutoLocation()" style="background:var(--pc-blue); color:white; border:none; border-radius:8px; padding:0 15px; font-size:20px;">üìç</button>
                </div>
            </div>

            <div class="input-group">
                <label>Foto dal Campo (Opzionale)</label>
                <input type="file" id="f_foto" accept="image/*" onchange="previewPhoto(this)" style="padding:8px;">
                <img id="photoPreview" src="">
            </div>

            <div class="input-group">
                <label>Urgenza Attivazione</label>
                <select id="f_tipo">
                    <option value="üî¥ IMMEDIATA">IMMEDIATA (Codice Rosso)</option>
                    <option value="üü° PROGRAMMATA">PROGRAMMATA (Pre-Allerta)</option>
                </select>
            </div>

            <div class="input-group">
                <label>Mezzi Richiesti</label>
                <input type="text" id="f_mezzi" placeholder="es: Unit√† Cinofila, Droni">
            </div>

            <div class="input-group">
                <label>Note Operative</label>
                <textarea id="f_note" rows="3" placeholder="Altre informazioni utili..."></textarea>
            </div>

            <button class="btn btn-danger" id="sendBtn" onclick="transmitAllertaCompleta()">üöÄ PUBBLICA ALLERTA SU TELEGRAM</button>
            <button class="btn btn-action" style="margin-top:10px; background:#21262d;" onclick="openMap()">üõ∞Ô∏è APRI MAPPA DI PRECISIONE</button>
        </div>
    </div>

    <div id="mod-presenze" class="hidden"><div class="card">Modulo Presenze in fase di caricamento...</div></div>
    <div id="mod-squadre" class="hidden"><div class="card">Modulo Squadre in fase di caricamento...</div></div>
    <div id="mod-volontari" class="hidden"><div class="card">Modulo Archivio Volontari in fase di caricamento...</div></div>
</div>

<div id="gpsModal" class="modal-full">
    <div id="map"></div>
    <div class="modal-footer">
        <input type="text" id="gpsCoords" readonly style="flex:1;">
        <button onclick="confirmGps()" class="btn btn-action" style="width:auto; padding:0 25px;">USA QUESTE</button>
        <button onclick="closeMap()" class="btn btn-danger" style="width:auto; padding:0 25px;">X</button>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // Configurazione Telegram
    const TOKEN = "8237203800:AAGzZi2zgPyAa6bCunZkNCzH7hlz5rNykVA";
    const ID_GRUPPO = "-1003709844017";
    const PIN_VALIDO = "123456789";

    let map;
    let idleTimer;

    // --- LOGICA ACCESSO ---
    function checkLogin() {
        const input = document.getElementById('loginInput').value;
        if(input === PIN_VALIDO) {
            document.getElementById('loginOverlay').style.display = 'none';
            initMap(); // Inizializza mappa in background
        } else {
            alert("PIN NON VALIDO");
            document.getElementById('loginInput').value = "";
        }
    }

    function resetTimer() {
        clearTimeout(idleTimer);
        // Timeout 10 minuti (600.000 ms)
        idleTimer = setTimeout(() => {
            alert("Sessione scaduta per inattivit√†.");
            location.reload();
        }, 600000);
    }

    // --- FUNZIONI MODULO ALLERTA (PUNTO 2) ---
    function getAutoLocation() {
        if (!navigator.geolocation) return alert("Il tuo browser non supporta il GPS");
        
        const btn = document.querySelector('button[onclick="getAutoLocation()"]');
        btn.innerText = "‚è≥";
        
        navigator.geolocation.getCurrentPosition(pos => {
            const coords = `${pos.coords.latitude.toFixed(6)}, ${pos.coords.longitude.toFixed(6)}`;
            document.getElementById('f_luogo').value = coords;
            btn.innerText = "üìç";
        }, err => {
            alert("Errore GPS: Assicurati di aver dato i permessi alla posizione.");
            btn.innerText = "üìç";
        });
    }

    function previewPhoto(input) {
        const preview = document.getElementById('photoPreview');
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = e => {
                preview.src = e.target.result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    async function transmitAllertaCompleta() {
        const btn = document.getElementById('sendBtn');
        const evento = document.getElementById('f_evento').value.toUpperCase();
        const luogo = document.getElementById('f_luogo').value;
        const tipo = document.getElementById('f_tipo').value;
        const mezzi = document.getElementById('f_mezzi').value;
        const note = document.getElementById('f_note').value;
        const foto = document.getElementById('f_foto').files[0];

        if(!evento || !luogo) return alert("Inserisci almeno Evento e Luogo!");

        btn.disabled = true;
        btn.innerText = "INVIO IN CORSO...";

        const messaggio = `‚ö†Ô∏è *NUOVA ALLERTA OPERATIVA*\n\n` +
                          `üìå *EVENTO:* ${evento}\n` +
                          `üö® *STATO:* ${tipo}\n` +
                          `üìç *LUOGO:* ${luogo}\n` +
                          `üöí *MEZZI:* ${mezzi || 'Nessuno specificato'}\n` +
                          `üìù *NOTE:* ${note || 'Nessuna'}\n\n` +
                          `üïí _Inviato: ${new Date().toLocaleString('it-IT')}_`;

        try {
            if (foto) {
                const formData = new FormData();
                formData.append('chat_id', ID_GRUPPO);
                formData.append('photo', foto);
                formData.append('caption', messaggio);
                formData.append('parse_mode', 'Markdown');
                await fetch(`https://api.telegram.org/bot${TOKEN}/sendPhoto`, { method: 'POST', body: formData });
            } else {
                await fetch(`https://api.telegram.org/bot${TOKEN}/sendMessage?chat_id=${ID_GRUPPO}&text=${encodeURIComponent(messaggio)}&parse_mode=Markdown`);
            }
            alert("ALLERTA INVIATA AL GRUPPO UNIT√Ä MERLINI!");
            // Pulisci form
            document.getElementById('f_evento').value = "";
            document.getElementById('f_note').value = "";
            document.getElementById('f_foto').value = "";
            document.getElementById('photoPreview').style.display = 'none';
        } catch (e) {
            alert("Errore di connessione. Riprova.");
        } finally {
            btn.disabled = false;
            btn.innerText = "üöÄ PUBBLICA ALLERTA SU TELEGRAM";
        }
    }

    // --- GESTIONE MAPPA ---
    function initMap() {
        map = L.map('map').setView([45.856, 9.397], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        map.on('click', e => {
            const c = `${e.latlng.lat.toFixed(6)},${e.latlng.lng.toFixed(6)}`;
            document.getElementById('gpsCoords').value = c;
        });
    }

    function openMap() { document.getElementById('gpsModal').style.display='flex'; setTimeout(()=>map.invalidateSize(), 200); }
    function closeMap() { document.getElementById('gpsModal').style.display='none'; }
    function confirmGps() { 
        const val = document.getElementById('gpsCoords').value;
        if(val) document.getElementById('f_luogo').value = val;
        closeMap(); 
    }

    // --- CAMBIO MODULO ---
    function showMod(id) {
        ['mod-allerta', 'mod-presenze', 'mod-squadre', 'mod-volontari'].forEach(m => {
            document.getElementById(m).classList.add('hidden');
        });
        document.getElementById('mod-'+id).classList.remove('hidden');
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-'+id).classList.add('active');
    }
</script>
</body>
</html>
